<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生物調査</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
    <header class="header">
        <h1>生物調査</h1>
        <p>自然の中での発見！自分だけの発見を持ち帰ろう！</p>
    </header>

    <main class="main-content">
        <div class="action-container">
            <section class="card">
                <button id="captureButton">カメラで撮影</button>
                <button id="uploadButton">画像をアップロード</button>
                <input type="file" id="uploadInput" accept="image/*" style="display:none;">
                <button id="identifyButton">識別する</button>
                <button id="takePhotoButton">拍照</button>
                <p>野生の生き物の写真を撮りましょう！</p>
                <video id="camera" autoplay playsinline hidden></video>
                <canvas id="snapshotCanvas" hidden></canvas>
                <div id="results"></div>
            </section>

            <section class="card">
                <button class="action-btn" onclick="captureAndShare()">投稿</button>
                <p>見つけたものをSNSに投稿しよう！</p>
            </section>
        </div>

        <section class="photo-gallery">
            <h2>最近撮った生物</h2>
            <div id="photoContainer" class="photo-container"></div>
        </section>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const uploadInput = document.getElementById('uploadInput');
            const uploadButton = document.getElementById('uploadButton');

            // Bind the upload button to trigger file input click
            uploadButton.addEventListener('click', () => uploadInput.click());

            // Bind the input change event to process uploaded images
            uploadInput.addEventListener('change', processImage);

            // Load stored photos when the page loads
            loadStoredPhotos();
        });

        function processImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const src = e.target.result; // Base64 image URL
                    displaySelectedPhoto(src); // Append photo to the gallery
                    storePhoto(src); // Save to localStorage
                };
                reader.readAsDataURL(file);
            } else {
                alert('画像ファイルを選択してください。');
            }
        }

        function displaySelectedPhoto(src) {
            const photoContainer = document.getElementById('photoContainer');
            const photoWrapper = document.createElement('div');
            photoWrapper.classList.add('photo-wrapper');
            const img = document.createElement('img');
            img.src = src;
            img.classList.add('captured-photo');
            photoWrapper.appendChild(img);
            photoContainer.appendChild(photoWrapper);
        }

        function storePhoto(src) {
            let storedPhotos = JSON.parse(localStorage.getItem('photos')) || [];
            storedPhotos.push(src);
            localStorage.setItem('photos', JSON.stringify(storedPhotos));
        }

        function loadStoredPhotos() {
            const photoContainer = document.getElementById('photoContainer');
            const storedPhotos = JSON.parse(localStorage.getItem('photos')) || [];
            storedPhotos.forEach((src) => {
                const photoWrapper = document.createElement('div');
                photoWrapper.classList.add('photo-wrapper');
                const img = document.createElement('img');
                img.src = src;
                img.classList.add('captured-photo');
                photoWrapper.appendChild(img);
                photoContainer.appendChild(photoWrapper);
            });
        }

        const camera = document.getElementById("camera");
        const snapshotCanvas = document.getElementById("snapshotCanvas");
        const captureButton = document.getElementById("captureButton");
        const takePhotoButton = document.getElementById("takePhotoButton");
        const resultsDiv = document.getElementById("results");
        let selectedImage = null;

        // Start camera with rear-facing mode
        captureButton.addEventListener("click", async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment" }
                });
                camera.srcObject = stream;
                camera.hidden = false;
                snapshotCanvas.hidden = false;
            } catch (error) {
                console.error("後置鏡頭無法啟用，使用默認鏡頭。", error);
                alert("後置鏡頭無法啟用，請確認設備支持。");
            }
        });

        // Take photo
        takePhotoButton.addEventListener("click", () => {
            const context = snapshotCanvas.getContext("2d");
            snapshotCanvas.width = camera.videoWidth;
            snapshotCanvas.height = camera.videoHeight;
            context.drawImage(camera, 0, 0); // Capture the camera feed into canvas
            const photo = snapshotCanvas.toDataURL("image/jpeg");
            displaySelectedPhoto(photo); // Display the photo
            storePhoto(photo); // Save the photo
            alert("照片已拍攝！");
        });
    </script>

    <nav class="navbar">
        <button onclick="window.location.href='index.html'">ホーム</button>
        <button onclick="goToEncyclopedia()">生物調査</button>
        <button onclick="window.location.href='gallery.html'">生物図鑑</button>
        <button>クイズ</button>
    </nav>
</body>
</html>
